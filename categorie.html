<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>Cat√©gories - AF.ELEC</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">

    <!-- ICON LOGO ENTREPRISE -->
    <link rel="icon" href="logo.png">

    <style>
        .stock-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 2rem;
        }

        /* ------------------------------
           LISTE DES CAT√âGORIES
        ------------------------------ */

        .categories-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .categorie-item {
            background-color: #ffffff;
            padding: 15px 20px;
            margin-bottom: 12px;
            border-radius: 10px;
            border: 1px solid #e0d6c8;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .categorie-item:hover {
            background-color: #f5efe6;
            transform: translateX(4px);
        }

        .cat-desc {
            margin: 5px 0 0;
            font-size: 14px;
            color: #6b4f2c;
        }

        /* ------------------------------
           BOUTON FLOTTANT AJOUTER
        ------------------------------ */

        .floating-add-btn {
            position: fixed;
            bottom: 25px;
            right: 25px;
            background-color: #9C5E3F;
            color: white;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 2rem;
            text-decoration: none;
            border: none;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0,0,0,0.25);
            transition: background-color 0.3s ease, transform 0.2s ease;
            z-index: 3000;
        }

        .floating-add-btn:hover {
            background-color: #6b4f2c;
            transform: scale(1.1);
        }

        /* ------------------------------
           POPUP (STYLE STOCK)
        ------------------------------ */

        .popup-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            backdrop-filter: blur(3px);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 5000;
        }

        .popup-box {
            background: #fcf8f2;
            padding: 2rem;
            border-radius: 12px;
            width: 350px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            position: relative;
        }

        .popup-box h2 {
            margin-top: 0;
            color: #6b4f2c;
        }

        .close-btn {
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 1.8rem;
            cursor: pointer;
            color: #6b4f2c;
            transition: 0.2s;
        }

        .close-btn:hover {
            color: #9C5E3F;
        }

        /* Inputs & textarea */
        .popup-box input,
        .popup-box textarea {
            width: 100%;                 /* exactement comme le bouton */
            padding: 0.8rem;             /* m√™me padding que le bouton */
            margin-bottom: 1rem;
            border: 1px solid #c8b8a6;
            border-radius: 6px;
            background-color: white;
            font-size: 1rem;
            color: #6b4f2c;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
            box-sizing: border-box;      /* garantit que la largeur inclut le padding */

        }



        .popup-box input:hover,
        .popup-box textarea:hover {
            border-color: #9C5E3F;
        }

        .popup-box input:focus,
        .popup-box textarea:focus {
            outline: none;
            border-color: #9C5E3F;
            box-shadow: 0 0 4px rgba(156, 94, 63, 0.4);
        }

        .popup-box textarea {
            resize: none;
            height: 80px;
        }

        /* Bouton Valider */

        .popup-submit {
            width: 100%;
            padding: 0.8rem;
            background-color: #9C5E3F;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            font-size: 1.3rem;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: background-color 0.3s ease, transform 0.2s ease;
        }

        .popup-submit:hover {
            background-color: #6b4f2c;
            transform: scale(1.05);
        }

        .popup-submit i {
            font-size: 1.6rem;
        }

        /* Bouton supprimer */

        .delete-btn-popup {
            width: 100%;
            padding: 0.8rem;
            background-color: #9C5E3F;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            font-size: 1.3rem;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: background-color 0.3s ease, transform 0.2s ease;
        }

        .delete-btn-popup:hover {
            background-color: #6b4f2c;
            transform: scale(1.05);
        }

        .delete-btn-popup i {
            font-size: 1.6rem;
        }

        /* Bouton modifier */

        .edit-btn-popup {
            width: 100%;
            padding: 0.8rem;
            background-color: #9C5E3F;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            font-size: 1.3rem;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: background-color 0.3s ease, transform 0.2s ease;
        }

        .edit-btn-popup:hover {
            background-color: #6b4f2c;
            transform: scale(1.05);
        }

        .edit-btn-popup i {
            font-size: 1.6rem;
        }

        #btn-modif-zone {
            display: none;
            margin-top: 1rem;
            display: flex;
            gap: 1rem;
        }

        .small-btn {
            flex: 1;
            padding: 0.6rem;
            font-size: 1.1rem;
        }

        .small-btn i {
            font-size: 1.4rem;
        }



    </style>

    <link rel="stylesheet" href="responsive.css">

</head>

<body>
<!-- HEADER / MENU -->
<header class="header">
    <div class="logo-container">
        <img src="logo.png" alt="Logo">
        <span>ELEC</span>
    </div>

    <nav>
        <a href="dashboard.html"><i class="bi bi-speedometer2"></i> Tableau de bord</a>
        <a href="stock.html"><i class="bi bi-box-seam"></i> Stock</a>
        <a href="categorie.html"><i class="bi bi-tags-fill"></i> Cat√©gories</a>
        <a href="restock.html"><i class="bi bi-arrow-repeat"></i> Restock</a>
        <a href="#" onclick="logout()"><i class="bi bi-power"></i></a>
    </nav>



    <!-- HEADER / MENU MOBILE -->
    <div class="header-mobile">

        <!-- Ic√¥ne menu -->
        <div class="icon-menu-custom" onclick="toggleMobileMenu()">
            <span></span>
            <span></span>
            <span></span>
        </div>

        <!-- MENU D√âPLIANT MOBILE -->
        <div class="side-menu" id="mobileMenu">

            <div class="menu-header">
                <span>Menu</span>
                <i class="bi bi-x-lg" onclick="toggleMobileMenu()"></i>
            </div>

            <div class="menu-links">
                <a href="dashboard.html"><i class="bi bi-speedometer2"></i> Tableau de bord</a>
                <a href="stock.html"><i class="bi bi-box-seam"></i> Stock</a>
                <a href="categorie.html"><i class="bi bi-tags-fill"></i> Cat√©gories</a>
                <a href="restock.html"><i class="bi bi-arrow-repeat"></i> Restock</a>
                <a href="#" onclick="logout()"><i class="bi bi-power"></i> D√©connexion</a>
            </div>

        </div>

    </div>


    <!--    <div class="icon-menu-custom">-->
    <!--        <span></span>-->
    <!--        <span></span>-->
    <!--        <span></span>-->
    <!--    </div>-->
</header>

<section class="container">
    <h1>Cat√©gories</h1>

    <ul id="liste-categories" class="categories-list"></ul>
</section>

<footer>
    <div class="align-nav">
        <h1>Navigation</h1>
    </div>

    <div class="footer-container">
        <table class="footer-table">
            <tr>
                <td><a href="dashboard.html"><i class="bi bi-speedometer2"></i> Tableau de bord</a></td>
                <td><a href="restock.html"><i class="bi bi-arrow-repeat"></i> Restock</a></td>
            </tr>

            <tr>
                <td><a href="stock.html"><i class="bi bi-box-seam"></i> Stock</a></td>
                <td><a href="index.html"><i class="bi bi-power"></i> D√©connexion</a></td>
            </tr>

            <tr>
                <td><a href="categorie.html"><i class="bi bi-tags-fill"></i> Cat√©gories</a></td>
                <td><p>hkqsfbjqfb</p></td>
            </tr>
        </table>
    </div>
</footer>

<!-- FOOTER MOBILE -->
<div class="footer-app">
    <nav class="footer-nav">
        <a href="dashboard.html"><i class="bi bi-speedometer2"></i></a>
        <a href="stock.html"><i class="bi bi-box-seam"></i></a>
        <a href="categorie.html"><i class="bi bi-tags-fill"></i></a>
        <a href="restock.html"><i class="bi bi-arrow-repeat"></i></a>
        <a href="#" onclick="logout()"><i class="bi bi-power"></i></a>
    </nav>
</div>

<!-- POPUP CAT√âGORIE -->
<div id="popup-categorie" class="popup-overlay">
    <div class="popup-box">

        <span class="close-btn" onclick="fermerPopupCategorie()">&times;</span>

        <h2 id="popup-categorie-title">Ajouter une cat√©gorie</h2>

        <form id="popup-categorie-form">

            <label>Nom :</label>
            <input type="text" id="categorie-nom" required>

            <label>Description :</label>
            <textarea id="categorie-description" required></textarea>

            <!-- Bouton AJOUT -->
            <button type="submit" class="popup-submit" id="btn-ajout">
                <i class="bi bi-check-lg"></i>
            </button>

            <!-- Boutons MODIFICATION -->
            <div id="btn-modif-zone">
                <button type="submit" class="edit-btn-popup small-btn">
                    <i class="bi bi-check-lg"></i>
                </button>

                <button type="button" id="delete-categorie-btn" class="delete-btn-popup small-btn">
                    <i class="bi bi-trash-fill"></i>
                </button>
            </div>

        </form>
    </div>
</div>

<!-- BOUTON FLOTTANT -->
<button id="btn-ajouter" class="floating-add-btn">
    <i class="bi bi-plus-lg"></i>
</button>



<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script>
    /* ---------------------------------------------------------- */
    /* üîê S√©curit√© */
    /* ---------------------------------------------------------- */
    if (localStorage.getItem("isLogged") !== "true") {
        window.location.href = "index.html";
    }

    function logout() {
        alert("Vous √™tes d√©connect√©");
        localStorage.removeItem("isLogged");
        window.location.href = "index.html";
    }

    /* ---------------------------------------------------------- */
    /* üîß Connexion Supabase */
    /* ---------------------------------------------------------- */
    const client = supabase.createClient(
        "https://dxqffvubixwsxnoaudat.supabase.co",
        "sb_publishable_Jg2Z_fDjwpY9yF5KQLbAOA_j7lsbav9"
    );

    /* ---------------------------------------------------------- */
    /* üì• Charger les cat√©gories */
    /* ---------------------------------------------------------- */
    async function chargerCategories() {
        const { data, error } = await client
            .from("categories")
            .select("*")
            .order("id", { ascending: true });

        if (error) {
            console.error("Erreur chargement cat√©gories :", error);
            return [];
        }

        return data;
    }

    /* ---------------------------------------------------------- */
    /* üì• V√©rifier si une cat√©gorie est utilis√©e dans stock */
    /* ---------------------------------------------------------- */
    async function categorieUtilisee(id) {
        // 1) R√©cup√©rer le nom de la cat√©gorie
        const { data: cat, error: errCat } = await client
            .from("categories")
            .select("nom")
            .eq("id", id)
            .single();

        if (errCat || !cat) {
            console.error("Erreur r√©cup√©ration cat√©gorie :", errCat);
            return false;
        }

        // 2) V√©rifier si ce nom appara√Æt dans stock.categorie
        const { data, error } = await client
            .from("stock")
            .select("id")
            .eq("categorie", cat.nom)
            .limit(1);

        if (error) {
            console.error("Erreur v√©rification utilisation :", error);
            return false;
        }

        return data.length > 0;
    }

    /* ---------------------------------------------------------- */
    /* üñ•Ô∏è Afficher les cat√©gories */
    /* ---------------------------------------------------------- */
    async function afficherCategories() {
        const list = document.getElementById("liste-categories");

        const categories = await chargerCategories();
        list.innerHTML = "";

        categories.forEach(cat => {
            list.innerHTML += `
                <li class="categorie-item" onclick="ouvrirPopupCategorie('modif', ${cat.id})">
                    <strong>${cat.nom}</strong>
                    <p class="cat-desc">${cat.description}</p>
                </li>
            `;
        });
    }

    /* ---------------------------------------------------------- */
    /* üîß Popup */
    /* ---------------------------------------------------------- */
    let categorieActuelle = null;

    function fermerPopupCategorie() {
        document.getElementById("popup-categorie").style.display = "none";
    }

    document.getElementById("btn-ajouter").addEventListener("click", () => {
        ouvrirPopupCategorie("ajout");
    });

    /* ---------------------------------------------------------- */
    /* üìù Ouvrir popup (ajout / modif) */
    /* ---------------------------------------------------------- */
    async function ouvrirPopupCategorie(mode, id = null) {
        document.getElementById("popup-categorie").style.display = "flex";

        const btnAjout = document.getElementById("btn-ajout");
        const btnModifZone = document.getElementById("btn-modif-zone");

        if (mode === "ajout") {
            categorieActuelle = null;

            document.getElementById("popup-categorie-title").textContent = "Ajouter une cat√©gorie";
            document.getElementById("categorie-nom").value = "";
            document.getElementById("categorie-description").value = "";

            btnAjout.style.display = "block";
            btnModifZone.style.display = "none";
        }

        if (mode === "modif") {
            const { data: cat } = await client
                .from("categories")
                .select("*")
                .eq("id", id)
                .single();

            categorieActuelle = cat;

            document.getElementById("popup-categorie-title").textContent = "Modifier la cat√©gorie";
            document.getElementById("categorie-nom").value = cat.nom;
            document.getElementById("categorie-description").value = cat.description;

            btnAjout.style.display = "none";
            btnModifZone.style.display = "flex";

            document.getElementById("delete-categorie-btn").onclick = () => supprimerCategorie(id);
        }
    }

    /* ---------------------------------------------------------- */
    /* üíæ Soumission formulaire */
    /* ---------------------------------------------------------- */
    document.getElementById("popup-categorie-form").addEventListener("submit", async (e) => {
        e.preventDefault();

        const nom = document.getElementById("categorie-nom").value.trim();
        const description = document.getElementById("categorie-description").value.trim();

        if (!categorieActuelle) {
            // AJOUT
            await client.from("categories").insert([{ nom, description }]);
        } else {
            // MODIFICATION
            await client
                .from("categories")
                .update({ nom, description })
                .eq("id", categorieActuelle.id);
        }

        afficherCategories();
        fermerPopupCategorie();
    });

    /* ---------------------------------------------------------- */
    /* üóëÔ∏è Supprimer une cat√©gorie */
    /* ---------------------------------------------------------- */
    async function supprimerCategorie(id) {
        const utilise = await categorieUtilisee(id);

        if (utilise) {
            alert("Impossible de supprimer : des produits utilisent cette cat√©gorie.");
            return;
        }

        await client.from("categories").delete().eq("id", id);

        afficherCategories();
        fermerPopupCategorie();
    }

    /* ---------------------------------------------------------- */
    /* üöÄ Charger au d√©marrage */
    /* ---------------------------------------------------------- */
    afficherCategories();
</script>

<script>
    function toggleMobileMenu() {
        document.getElementById("mobileMenu").classList.toggle("open");
    }
</script>

</body>

</html>
